Description: Support native popups in oxide
Author: Chris Coulson <chris.coulson@canonical.com>

Index: oxide/chromium/src/content/browser/renderer_host/render_view_host_impl.cc
===================================================================
--- oxide.orig/chromium/src/content/browser/renderer_host/render_view_host_impl.cc	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/browser/renderer_host/render_view_host_impl.cc	2013-08-15 23:57:57.963131702 +0100
@@ -991,7 +991,7 @@
                         OnShowDesktopNotification)
     IPC_MESSAGE_HANDLER(DesktopNotificationHostMsg_Cancel,
                         OnCancelDesktopNotification)
-#if defined(OS_MACOSX) || defined(OS_ANDROID)
+#if defined(OS_MACOSX) || defined(OS_ANDROID) || defined(OXIDE_BUILD)
     IPC_MESSAGE_HANDLER(ViewHostMsg_ShowPopup, OnShowPopup)
 #endif
     IPC_MESSAGE_HANDLER(ViewHostMsg_RunFileChooser, OnRunFileChooser)
@@ -1669,7 +1669,7 @@
   RenderWidgetHostImpl::ForwardKeyboardEvent(key_event);
 }
 
-#if defined(OS_ANDROID)
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
 void RenderViewHostImpl::DidSelectPopupMenuItems(
     const std::vector<int>& selected_indices) {
   Send(new ViewMsg_SelectPopupMenuItems(GetRoutingID(), false,
@@ -2008,7 +2008,7 @@
       GetRoutingID(), snapshot_id, gfx::Size(), png));
 }
 
-#if defined(OS_MACOSX) || defined(OS_ANDROID)
+#if defined(OS_MACOSX) || defined(OS_ANDROID) || defined (OXIDE_BUILD)
 void RenderViewHostImpl::OnShowPopup(
     const ViewHostMsg_ShowPopup_Params& params) {
   RenderViewHostDelegateView* view = delegate_->GetDelegateView();
Index: oxide/chromium/src/content/renderer/render_thread_impl.cc
===================================================================
--- oxide.orig/chromium/src/content/renderer/render_thread_impl.cc	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/renderer/render_thread_impl.cc	2013-08-15 23:57:57.967131702 +0100
@@ -323,7 +323,7 @@
   v8::V8::SetCreateHistogramFunction(CreateHistogram);
   v8::V8::SetAddHistogramSampleFunction(AddHistogramSample);
 
-#if defined(OS_MACOSX) || defined(OS_ANDROID)
+#if defined(OS_MACOSX) || defined(OS_ANDROID) || defined(OXIDE_BUILD)
   // On Mac and Android, the select popups are rendered by the browser.
   WebKit::WebView::setUseExternalPopupMenus(true);
 #endif
Index: oxide/chromium/src/content/browser/renderer_host/render_view_host_impl.h
===================================================================
--- oxide.orig/chromium/src/content/browser/renderer_host/render_view_host_impl.h	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/browser/renderer_host/render_view_host_impl.h	2013-08-15 23:57:57.967131702 +0100
@@ -391,7 +391,9 @@
   media::MediaPlayerManager* media_player_manager() {
     return media_player_manager_;
   }
+#endif
 
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
   void DidSelectPopupMenuItems(const std::vector<int>& selected_indices);
   void DidCancelPopupMenu();
 #endif
@@ -577,7 +579,7 @@
                               int automation_id);
   void OnGetWindowSnapshot(const int snapshot_id);
 
-#if defined(OS_MACOSX) || defined(OS_ANDROID)
+#if defined(OS_MACOSX) || defined(OS_ANDROID) || defined(OXIDE_BUILD)
   void OnShowPopup(const ViewHostMsg_ShowPopup_Params& params);
 #endif
 
Index: oxide/chromium/src/content/common/view_messages.h
===================================================================
--- oxide.orig/chromium/src/content/common/view_messages.h	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/common/view_messages.h	2013-08-15 23:59:45.875131823 +0100
@@ -1268,6 +1268,7 @@
 IPC_MESSAGE_CONTROL1(ViewMsg_SetWebKitSharedTimersSuspended,
                      bool /* suspend */)
 
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
 #if defined(OS_ANDROID)
 // Sent when the browser wants the bounding boxes of the current find matches.
 //
@@ -1281,12 +1282,14 @@
 // final_update set to true).
 IPC_MESSAGE_ROUTED1(ViewMsg_FindMatchRects,
                     int /* current_version */)
+#endif
 
 // External popup menus.
 IPC_MESSAGE_ROUTED2(ViewMsg_SelectPopupMenuItems,
                     bool /* user canceled the popup */,
                     std::vector<int> /* selected indices */)
 
+#if defined(OS_ANDROID)
 // Tells the renderer to try to revert to the zoom level we were at before
 // ViewMsg_ScrollFocusedEditableNodeIntoView was called.
 IPC_MESSAGE_ROUTED0(ViewMsg_UndoScrollFocusedEditableNodeIntoView)
@@ -1311,6 +1314,7 @@
 // Sent by the browser when an IME update that requires acknowledgement has been
 // processed on the browser side.
 IPC_MESSAGE_ROUTED0(ViewMsg_ImeEventAck)
+#endif
 
 #elif defined(OS_MACOSX)
 // Let the RenderView know its window has changed visibility.
Index: oxide/chromium/src/content/renderer/render_view_impl.cc
===================================================================
--- oxide.orig/chromium/src/content/renderer/render_view_impl.cc	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/renderer/render_view_impl.cc	2013-08-15 23:57:57.967131702 +0100
@@ -1426,15 +1426,19 @@
 #endif
     IPC_MESSAGE_HANDLER(ViewMsg_SetAccessibilityMode, OnSetAccessibilityMode)
     IPC_MESSAGE_HANDLER(ViewMsg_DisownOpener, OnDisownOpener)
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
 #if defined(OS_ANDROID)
     IPC_MESSAGE_HANDLER(InputMsg_ActivateNearestFindResult,
                         OnActivateNearestFindResult)
     IPC_MESSAGE_HANDLER(ViewMsg_FindMatchRects, OnFindMatchRects)
+#endif
     IPC_MESSAGE_HANDLER(ViewMsg_SelectPopupMenuItems, OnSelectPopupMenuItems)
+#if defined(OS_ANDROID)
     IPC_MESSAGE_HANDLER(ViewMsg_UndoScrollFocusedEditableNodeIntoView,
                         OnUndoScrollFocusedEditableNodeIntoRect)
     IPC_MESSAGE_HANDLER(ViewMsg_UpdateTopControlsState,
                         OnUpdateTopControlsState)
+#endif
 #elif defined(OS_MACOSX)
     IPC_MESSAGE_HANDLER(InputMsg_CopyToFindPboard, OnCopyToFindPboard)
     IPC_MESSAGE_HANDLER(ViewMsg_PluginImeCompositionCompleted,
@@ -6348,7 +6352,7 @@
 }
 #endif
 
-#if defined(OS_ANDROID)
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
 void RenderViewImpl::OnSelectPopupMenuItems(
     bool canceled,
     const std::vector<int>& selected_indices) {
Index: oxide/chromium/src/content/renderer/render_view_impl.h
===================================================================
--- oxide.orig/chromium/src/content/renderer/render_view_impl.h	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/renderer/render_view_impl.h	2013-08-15 23:57:57.971131702 +0100
@@ -1052,15 +1052,19 @@
 
   void OnDisownOpener();
 
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
 #if defined(OS_ANDROID)
   void OnActivateNearestFindResult(int request_id, float x, float y);
   void OnFindMatchRects(int current_version);
+#endif
   void OnSelectPopupMenuItems(bool canceled,
                               const std::vector<int>& selected_indices);
+#if defined(OS_ANDROID)
   void OnUndoScrollFocusedEditableNodeIntoRect();
   void OnUpdateTopControlsState(bool enable_hiding,
                                 bool enable_showing,
                                 bool animate);
+#endif
 #elif defined(OS_MACOSX)
   void OnCopyToFindPboard();
   void OnPluginImeCompositionCompleted(const string16& text, int plugin_id);
Index: oxide/chromium/src/content/renderer/external_popup_menu.cc
===================================================================
--- oxide.orig/chromium/src/content/renderer/external_popup_menu.cc	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/renderer/external_popup_menu.cc	2013-08-15 23:57:57.971131702 +0100
@@ -54,7 +54,7 @@
 }
 #endif
 
-#if defined(OS_ANDROID)
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
 void ExternalPopupMenu::DidSelectItems(bool canceled,
                                        const std::vector<int>& indices) {
   if (!popup_menu_client_)
Index: oxide/chromium/src/content/renderer/external_popup_menu.h
===================================================================
--- oxide.orig/chromium/src/content/renderer/external_popup_menu.h	2013-08-15 23:57:57.975131702 +0100
+++ oxide/chromium/src/content/renderer/external_popup_menu.h	2013-08-15 23:57:57.971131702 +0100
@@ -32,7 +32,7 @@
   void DidSelectItem(int selected_index);
 #endif
 
-#if defined(OS_ANDROID)
+#if defined(OS_ANDROID) || defined(OXIDE_BUILD)
   // Called when the user has selected items or canceled the popup.
   void DidSelectItems(bool canceled, const std::vector<int>& selected_indices);
 #endif
